#!/usr/bin/env php
<?php
use Acelaya\Expressive\Router\SlimRouter;
use Acelaya\Website\Feed\BlogOptions;
use Acelaya\Website\Feed\Twig\Extension\BlogExtension;
use Acelaya\Website\Service\RouteAssembler;
use Acelaya\Website\Template\Extension\NavigationExtension;
use Acelaya\Website\Template\Extension\RecaptchaExtension;
use Acelaya\Website\Template\Extension\TranslatorExtension;
use Acelaya\Website\Template\Extension\UrlExtension;
use Doctrine\Common\Cache\ArrayCache;
use Zend\Diactoros\ServerRequestFactory;
use Zend\I18n\Translator\Translator;

/**
 * Extracts translations from twig templates.
 *
 * @author Саша Стаменковић <umpirsky@gmail.com>
 */
require_once __DIR__ . '/../vendor/autoload.php';

$twig = new Twig_Environment(new Twig\Gettext\Loader\Filesystem('/'), [
    'cache'       => implode(DIRECTORY_SEPARATOR, [sys_get_temp_dir(), 'cache', uniqid('ac', true)]),
    'auto_reload' => true
]);
// You can add more extensions here.
$routeAssembler = new RouteAssembler(new SlimRouter(), ServerRequestFactory::fromGlobals());
$translator = Translator::factory([]);
$twig->addExtension(new NavigationExtension($translator, $routeAssembler, []));
$twig->addExtension(new UrlExtension($routeAssembler));
$twig->addExtension(new TranslatorExtension($translator));
$twig->addExtension(new RecaptchaExtension([]));
$twig->addExtension(new BlogExtension(new ArrayCache(), new BlogOptions()));

array_shift($_SERVER['argv']);

$addTemplate = false;
$setFunctions = false;
$setFilters = false;
$addTemplate = false;
$setExecutable = false;
$extractor = new Twig\Gettext\Extractor($twig);

foreach ($_SERVER['argv'] as $arg) {
    if ('--files' === $arg) {
        $addTemplate = true;
    } else if ($addTemplate) {
        $extractor->addTemplate(getcwd() . DIRECTORY_SEPARATOR . $arg);
    } else if ('--exec' === $arg) {
        $setExecutable = true;
    } else if ($setExecutable) {
        $extractor->setExecutable($arg);
        $setExecutable = false;
    } else if ('--functions' === $arg) {
        $setFunctions = true;
    } else if ($setFunctions) {
        foreach (explode(',', $arg) as $functionName) {
            $twig->addFunction(new \Twig_SimpleFunction($functionName, true));
        }
        $setFunctions = false;
    } else if ('--filters' === $arg) {
        $setFilters = true;
    } else if ($setFilters) {
        foreach (explode(',', $arg) as $filterName) {
            $twig->addFilter(new \Twig_SimpleFilter($filterName, true));
        }
        $setFilters = false;
    } else {
        $extractor->addGettextParameter($arg);
    }
}

$extractor->extract();
